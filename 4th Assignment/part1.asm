.include "m328PBdef.inc"
.equ PD3 = 3
.equ PD2 = 2
.def temp = r16
.org 0x00
 jmp reset

.org 0x2A 
 jmp conversion
reset:
    ldi temp, high(RAMEND)
    out SPH,temp
    ldi temp, low(RAMEND)
    out SPL,temp
    
    sei
  


    ser r24
    out DDRD, r24 
    rcall lcd_init 
    ldi r24, low(2)
    ldi r25, high(2) 
    rcall wait_msec

    ldi temp, 0xFF
    out DDRB, temp 

    ldi temp, 0x00
    out DDRC, temp

    ldi temp, 0b01000010 
    sts ADMUX, temp
    
    ldi temp, 0b10101111
    sts ADCSRA, temp

    ldi temp, 0b00000000
    sts ADCSRB, temp

    ldi r20,0x00
    out PORTB, r20
    
    ldi r24, HIGH(6070)  
    sts TCNT1H, r24 
    ldi r24, LOW(6070)
    sts TCNT1L, r24



start:
    lds temp, ADCSRA 
    ori temp, (1<<ADSC) 
    sts ADCSRA, temp

count:
    ldi r24, low(1000)
    ldi r25, high(1000)
    rcall wait_msec
    inc r20
    out PORTB, r20
    jmp count


conversion:
rcall lcd_init 
ldi r24, low(2)
ldi r25, high(2) 
rcall wait_msec
lds r17,ADCL 
lds r18,ADCH 
mov r22,r18
mov r21,r17
lsl r17
rol r18
lsl r17
rol r18
add r17,r21
adc r18,r22
mov r22,r18
andi r18,0b00011100
sub r22,r18
lsr r18
lsr r18
ori r18,0b00110000
mov r24,r18
rcall lcd_data 


ldi r24, '.'
rcall lcd_data 


mov r21,r17
mov r18,r22
lsl r17
rol r18
lsl r17
rol r18
lsl r17
rol r18
add r17,r21
adc r18,r22
add r17,r21
adc r18,r22
mov r22,r18
andi r18,0b00111100
sub r22,r18
lsr r18
lsr r18
ori r18,0b00110000
mov r24, r18
rcall lcd_data 





mov r18,r22
mov r21,r17
lsl r17
rol r18
lsl r17
rol r18
lsl r17
rol r18
add r17,r21
adc r18,r22
add r17,r21
adc r18,r22
andi r18,0b00111100
lsr r18
lsr r18
ori r18,0b00110000
mov r24, r18
rcall lcd_data 
ldi r24, low(500)
ldi r25, high(500)
rcall wait_msec
reti



lcd_init:
ldi r24 ,40 ; ???? ? ???????? ??? lcd ????????????? ??
ldi r25 ,0 ; ????? ??????? ??? ???? ??? ????????????.
rcall wait_msec ; ??????? 40 msec ????? ???? ?? ???????????.
ldi r24 ,0x30 ; ?????? ????????? ?? 8 bit mode
out PORTD ,r24 ; ?????? ??? ???????? ?? ??????? ???????
 sbi PORTD ,PD3 ; ??? ?? ?????????? ??????? ??? ???????
cbi PORTD ,PD3 ; ??? ??????, ? ?????? ???????????? ??? ?????
ldi r24 ,100
ldi r25 ,0 ; ??? ? ???????? ??? ?????? ????????? ?? 8-bit mode
rcall wait_usec ; ??? ?? ?????? ??????, ???? ?? ? ???????? ???? ??????????
 ; ??????? 4 bit ?? ??????? ?? ?????????? 8 bit
 ldi r24 ,0x30
out PORTD ,r24
 sbi PORTD ,PD3
cbi PORTD ,PD3
ldi r24 ,100
ldi r25 ,0
rcall wait_usec
ldi r24 ,0x20 ; ?????? ?? 4-bit mode
out PORTD ,r24
 sbi PORTD ,PD3
cbi PORTD ,PD3
ldi r24 ,100
ldi r25 ,0
rcall wait_usec
 ldi r24 ,0x28 ; ??????? ?????????? ???????? 5x8 ????????
 rcall lcd_command ; ??? ???????? ??? ??????? ???? ?????
ldi r24 ,0x0c ; ???????????? ??? ??????, ???????? ??? ???????
 rcall lcd_command
 ldi r24 ,0x01 ; ?????????? ??? ??????
rcall lcd_command
ldi r24 ,low(5000)
ldi r25 ,high(5000)
rcall wait_usec
 ldi r24 ,0x06 ; ???????????? ????????? ??????? ???? 1 ??? ??????????
rcall lcd_command ; ??? ????? ???????????? ???? ??????? ??????????? ???
 ; ?????????????? ??? ????????? ????????? ??? ??????
ret

lcd_command:
cbi PORTD ,PD2 ; ??????? ??? ?????????? ??????? (PD2=1)
rcall write_2_nibbles ; ???????? ??? ??????? ??? ??????? 39?sec
 ldi r24 ,100 ; ??? ??? ?????????? ??? ????????? ??? ??? ??? ??????? ??? lcd.
ldi r25 ,0 ; ???.: ???????? ??? ???????, clear display ??? return home,
rcall wait_usec ; ??? ???????? ????????? ?????????? ??????? ????????.
ret

lcd_data:
 sbi PORTD ,PD2 ; ??????? ??? ?????????? ????????? (PD2=1)
rcall write_2_nibbles ; ???????? ??? byte
ldi r24 ,100 ; ??????? 43?sec ????? ?? ??????????? ? ????
ldi r25 ,0 ; ??? ????????? ??? ??? ??????? ??? lcd
rcall wait_usec
ret

write_2_nibbles:
push r24 ; ??????? ?? 4 MSB
in r25 ,PIND ; ??????????? ?? 4 LSB ??? ?? ?????????????
andi r25 ,0x0f ; ??? ?? ??? ????????? ??? ????? ??????????? ?????????
andi r24 ,0xf0 ; ????????????? ?? 4 MSB ???
add r24 ,r25 ; ???????????? ?? ?? ???????????? 4 LSB
out PORTD ,r24 ; ??? ???????? ???? ?????
 sbi PORTD ,PD3 ; ????????????? ?????? Enable ???? ????????? PD3
cbi PORTD ,PD3 ; PD3=1 ??? ???? PD3=0
pop r24 ; ??????? ?? 4 LSB. ????????? ?? byte.
 swap r24 ; ????????????? ?? 4 MSB ?? ?? 4 LSB
andi r24 ,0xf0 ; ??? ?? ??? ????? ???? ?????????????
add r24 ,r25
out PORTD ,r24
 sbi PORTD ,PD3 ; ???? ?????? Enable
cbi PORTD ,PD3
ret

wait_msec:			; 1 msec delay per call
push r24			; 2 cycles
push r25			; 2 cycles
ldi r24,low(125)		; 1 cycle
ldi r25,high(125)		; 1 cycle
rcall wait_usec		; 3 cycles
pop r25			; 2 cycles
pop r24			; 2 cycles
sbiw r24,1			; 2 cycles
brne wait_msec		; 1 or 2 cycles
ret				; 4 cycles
    
wait_usec:			; Called 125 times
sbiw r24,1			; 2 cycles (2 usec)
nop				; 1 cycle (1 usec)
nop				; 1 cycle (1 usec)
nop				; 1 cycle (1 usec)
nop				; 1 cycle (1 usec)
brne wait_usec		; 1 or 2 cycles (1 or 2 usec)
ret				; 4 cycles (4 usec)  

